<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Vortex Innovators</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container {
            padding: 120px 20px 50px;
            max-width: 1200px;
            margin: 0 auto;
            color: #fff;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            overflow: hidden;
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            background: rgba(0, 0, 0, 0.5);
            color: #00d2ff;
            font-weight: 700;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .status-paid {
            color: #00ff88;
            font-weight: bold;
        }

        .status-pending {
            color: #ffaa00;
            font-weight: bold;
        }

        .action-btn {
            padding: 5px 10px;
            background: #00d2ff;
            color: #000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            margin-right: 5px;
        }

        .delete-btn {
            background: #ff4444;
            color: #fff;
        }
    </style>
</head>

<body>
    <nav class="glass-nav">
        <div class="nav-content">
            <div class="brand-container">
                <a href="index.html">
                    <img src="https://image2url.com/r2/default/images/1771323328076-73754ca7-5637-40c3-9e39-77832d8f5a18.jpeg"
                        alt="Vortex Logo" class="nav-logo-img"
                        style="height: 40px; margin-right: 10px; vertical-align: middle;">
                </a>
                <a href="index.html" class="logo">VORTEX ADMIN</a>
            </div>

            <!-- Admin always has logout in nav, so we might not need a login button here. 
                 But to keep layout stable, we can add a placeholder or just let flexbox handle it. -->

            <div class="hamburger">
                <div class="line1"></div>
                <div class="line2"></div>
                <div class="line3"></div>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-item">Home</a>
                <a href="#" onclick="logout()">Logout</a>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <div class="admin-header">
            <h1>Event Registrations</h1>
            <div style="display: flex; gap: 10px;">
                <select id="status-filter" class="action-btn"
                    style="background: #333; color: white; border: 1px solid #555;">
                    <option value="PAID" style="background: #333; color: #00ff88; font-weight: bold;" selected>PAID ONLY
                    </option>
                    <option value="all" style="background: #333; color: white;">All Status</option>
                    <option value="PENDING" style="background: #333; color: #ffaa00;">Pending</option>
                </select>
                <select id="event-filter" class="action-btn"
                    style="background: #333; color: white; border: 1px solid #555;">
                    <option value="all" style="background: #333; color: white;">All Events</option>
                </select>
                <button onclick="exportExcel()" class="action-btn" style="background: #00ff88; color: #000;">Export to
                    Excel</button>
                <button onclick="fetchData()" class="action-btn">Refresh Data</button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Mobile</th>
                        <th>Event</th>
                        <th>Details</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="data-body">
                    <tr>
                        <td colspan="7">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>


    <script>
        let allRegistrations = [];

        async function fetchData() {
            const token = localStorage.getItem('vortexToken');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const res = await fetch('/api/admin/registrations', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.status === 401) {
                    const errorText = await res.text(); // Get error details from server
                    console.error("Session Expired (401):", errorText);
                    alert("Session expired. Please login again.\nReason: " + errorText);
                    localStorage.removeItem('vortexToken');
                    localStorage.removeItem('vortexCurrentUser');
                    window.location.href = 'login.html';
                    return;
                }

                if (res.status === 403) {
                    alert("Access Denied: Admin privileges required.");
                    window.location.href = 'index.html';
                    return;
                }

                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`Server Error (${res.status}): ${errorText}`);
                }

                allRegistrations = await res.json();
                populateEventFilter(allRegistrations);

                // Default to PENDING loop for manual verification focus, or keep PAID
                // document.getElementById('status-filter').value = 'PENDING'; 
                filterAndRender();
            } catch (error) {
                console.error("Fetch Error:", error);
                document.getElementById('data-body').innerHTML = `
                    <tr>
                        <td colspan="8" style="color:red; text-align:center; padding: 20px;">
                            <strong>Error loading data:</strong> ${error.message}<br>
                            <small>Check console for details. Ensure you are logged in as Admin.</small>
                            <button onclick="fetchData()" class="action-btn" style="margin-top:10px;">Retry</button>
                        </td>
                    </tr>`;
            }
        }

        function exportExcel() {
            if (!allRegistrations || allRegistrations.length === 0) {
                alert("No data available to export.");
                return;
            }

            try {
                // Convert to simple CSV
                const headers = ["Ticket ID", "Name", "Event", "Email", "Phone", "Department", "Year", "College", "Date", "Payment Status", "Transaction ID"];

                // Map data to array of arrays
                const rows = allRegistrations.map(r => [
                    r.ticketId || '',
                    `"${(r.name || '').replace(/"/g, '""')}"`, // Escape quotes
                    `"${(r.event || '').replace(/"/g, '""')}"`,
                    r.email || '',
                    r.phone || '',
                    r.department || '',
                    r.year || '',
                    `"${(r.college || '').replace(/"/g, '""')}"`,
                    r.date ? new Date(r.date).toLocaleDateString() : '',
                    r.paymentStatus || 'PENDING',
                    r.transactionId || r.paymentId || '' // Use verification field
                ]);

                // Combine headers and rows
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.join(','))
                ].join('\n');

                // Create blob and download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `vortex_registrations_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error("Export error:", error);
                alert("Failed to export data: " + error.message);
            }
        }

        function populateEventFilter(data) {
            const filter = document.getElementById('event-filter');
            const currentSelection = filter.value;
            const events = [...new Set(data.map(item => item.event).filter(Boolean))];

            filter.innerHTML = '<option value="all" style="background: #333; color: white;">All Events</option>' +
                events.map(event => `<option value="${event}" style="background: #333; color: white;">${event}</option>`).join('');

            if (events.includes(currentSelection)) {
                filter.value = currentSelection;
            }
        }

        document.getElementById('event-filter').addEventListener('change', filterAndRender);
        document.getElementById('status-filter').addEventListener('change', filterAndRender);

        function filterAndRender() {
            const eventFilter = document.getElementById('event-filter').value;
            const statusFilter = document.getElementById('status-filter').value;

            let filteredData = allRegistrations;

            // Filter by Event
            if (eventFilter !== 'all') {
                filteredData = filteredData.filter(item => item.event === eventFilter);
            }

            // Filter by Status
            if (statusFilter !== 'all') {
                // If filtering by PAID, match "PAID". If PENDING, match anything else or specific "PENDING"
                if (statusFilter === 'PAID') {
                    filteredData = filteredData.filter(item => item.paymentStatus === 'PAID');
                } else {
                    filteredData = filteredData.filter(item => item.paymentStatus !== 'PAID');
                }
            }

            renderTable(filteredData);
        }

        function renderTable(data) {
            const tbody = document.getElementById('data-body');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No registrations found.</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => {
                const isPaid = item.paymentStatus === 'PAID';
                // Use transactionId from manual flow or paymentId from Razorpay
                const transId = item.transactionId || item.paymentId || '-';

                return `
                <tr>
                    <td>${new Date(item.date).toLocaleDateString()}</td>
                    <td>
                        <div style="font-weight:bold;">${item.name}</div>
                        <div style="font-size:0.8em; color:#aaa;">${item.email}</div>
                    </td>
                    <td>${item.phone}</td>
                    <td>${item.event}</td>
                    <td>
                        <div style="font-size:0.85em;">
                            ${item.department}<br>
                            ${item.year}Yr â€¢ ${item.college}
                        </div>
                    </td>
                    <td class="${isPaid ? 'status-paid' : 'status-pending'}">
                        ${item.paymentStatus || 'PENDING'}
                    </td>
                    <td>
                        ${!isPaid ?
                        `<button onclick="verifyPayment('${item.ticketId}', 'approve')" class="action-btn" style="background:#00ff88; color:black; margin-bottom:5px;">Approve</button>` :
                        ''}
                        <button onclick="deleteRegistration('${item.ticketId || item._id}')" class="action-btn delete-btn">Delete</button>
                    </td>
                </tr>
            `}).join('');
        }

        async function verifyPayment(ticketId, action) {
            if (!confirm(`Are you sure you want to ${action.toUpperCase()} this payment?`)) return;

            const token = localStorage.getItem('vortexToken');
            try {
                const res = await fetch('/api/admin/verify-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ ticketId, action })
                });

                const data = await res.json();
                if (res.ok) {
                    alert("Success: " + data.message);
                    fetchData(); // Refresh table
                } else {
                    alert("Error: " + data.error);
                }
            } catch (error) {
                console.error(error);
                alert("Failed to verify payment.");
            }
        }

        async function deleteRegistration(identifier) {
            console.log("Attempting to delete:", identifier);
            if (!confirm(`Are you sure you want to delete registration?`)) return;

            const token = localStorage.getItem('vortexToken');
            try {
                const res = await fetch(`/api/admin/registration/${identifier}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    alert("Registration deleted.");
                    fetchData(); // Refresh table
                } else {
                    const data = await res.json();
                    alert("Error: " + data.error);
                }
            } catch (error) {
                console.error(error);
                alert("Failed to delete.");
            }
        }


        function logout() {
            localStorage.removeItem('vortexToken');
            localStorage.removeItem('vortexCurrentUser');
            window.location.href = 'index.html';
        }

        window.onload = fetchData;
    </script>
</body>

</html>