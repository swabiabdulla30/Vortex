<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Vortex Innovators</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container {
            padding: 120px 20px 50px;
            max-width: 1200px;
            margin: 0 auto;
            color: #fff;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            overflow: hidden;
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            background: rgba(0, 0, 0, 0.5);
            color: #00d2ff;
            font-weight: 700;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .status-paid {
            color: #00ff88;
            font-weight: bold;
        }

        .status-pending {
            color: #ffaa00;
            font-weight: bold;
        }

        .action-btn {
            padding: 5px 10px;
            background: #00d2ff;
            color: #000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            margin-right: 5px;
        }

        .delete-btn {
            background: #ff4444;
            color: #fff;
        }
    </style>
</head>

<body>
    <nav class="glass-nav">
        <div class="nav-content">
            <div class="brand-container">
                <a href="index.html">
                    <img src="https://image2url.com/r2/default/images/1771323328076-73754ca7-5637-40c3-9e39-77832d8f5a18.jpeg"
                        alt="Vortex Logo" class="nav-logo-img"
                        style="height: 40px; margin-right: 10px; vertical-align: middle;">
                </a>
                <a href="index.html" class="logo">VORTEX ADMIN</a>
            </div>

            <!-- Admin always has logout in nav, so we might not need a login button here. 
                 But to keep layout stable, we can add a placeholder or just let flexbox handle it. -->

            <div class="hamburger">
                <div class="line1"></div>
                <div class="line2"></div>
                <div class="line3"></div>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-item">Home</a>
                <a href="#" onclick="logout()">Logout</a>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <div class="admin-header">
            <h1>Event Registrations</h1>
            <div style="display: flex; gap: 10px;">
                <select id="status-filter" class="action-btn"
                    style="background: #333; color: white; border: 1px solid #555;">
                    <option value="PAID" style="background: #333; color: #00ff88; font-weight: bold;" selected>PAID ONLY
                    </option>
                    <option value="all" style="background: #333; color: white;">All Status</option>
                    <option value="PENDING" style="background: #333; color: #ffaa00;">Pending</option>
                </select>
                <select id="event-filter" class="action-btn"
                    style="background: #333; color: white; border: 1px solid #555;">
                    <option value="all" style="background: #333; color: white;">All Events</option>
                </select>
                <button onclick="exportExcel()" class="action-btn" style="background: #00ff88; color: #000;">Export to
                    Excel</button>
                <button onclick="fetchData()" class="action-btn">Refresh Data</button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Event</th>
                        <!-- Transaction ID removed -->
                        <th>Details</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="data-body">
                    <tr>
                        <td colspan="6">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>


    <script>
        // ... (existing code) ...

        function renderTable(data) {
            const tbody = document.getElementById('data-body');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No registrations found.</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => {
                const isPaid = item.paymentStatus === 'PAID';
                // Transaction ID removed from display

                return `
                <tr>
                    <td>${new Date(item.date).toLocaleDateString()}</td>
                    <td>
                        <div style="font-weight:bold;">${item.name}</div>
                        <div style="font-size:0.8em; color:#aaa;">${item.email}</div>
                        <div style="font-size:0.8em; color:#aaa;">${item.phone}</div>
                    </td>
                    <td>${item.event}</td>
                    <!-- Trans ID col removed -->
                    <td>
                        <div style="font-size:0.85em;">
                            ${item.department}<br>
                            ${item.year}Yr â€¢ ${item.college}
                        </div>
                    </td>
                    <td class="${isPaid ? 'status-paid' : 'status-pending'}">
                        ${item.paymentStatus || 'PENDING'}
                    </td>
                    <td>
                        ${!isPaid ?
                        `<button onclick="verifyPayment('${item.ticketId}', 'approve')" class="action-btn" style="background:#00ff88; color:black; margin-bottom:5px;">Approve</button>` :
                        ''}
                        <button onclick="deleteRegistration('${item._id}')" class="action-btn delete-btn">Delete</button>
                    </td>
                </tr>
            `}).join('');
        }

        // ... verifyPayment ...

        async function deleteRegistration(id) {
            console.log("Attempting to delete MongoDB ID:", id);
            if (!confirm("Are you sure you want to PERMANENTLY delete this registration?")) return;

            const token = localStorage.getItem('vortexToken');
            try {
                // Reverted to using ID driven delete
                const res = await fetch(`/api/admin/registration/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    alert("Registration deleted successfully.");
                    fetchData(); // Refresh table
                } else {
                    const data = await res.json();
                    alert("Delete Failed: " + (data.error || res.statusText));
                }
            } catch (error) {
                console.error("Delete Network Error:", error);
                alert("Network error: Failed to reach server.");
            }
        }

        if (res.ok) {
            alert("Registration deleted.");
            fetchData(); // Refresh table
        } else {
            const data = await res.json();
            alert("Error: " + data.error);
        }
            } catch (error) {
            console.error(error);
            alert("Failed to delete.");
        }
        }


        function logout() {
            localStorage.removeItem('vortexToken');
            localStorage.removeItem('vortexCurrentUser');
            window.location.href = 'index.html';
        }

        window.onload = fetchData;
    </script>
</body>

</html>